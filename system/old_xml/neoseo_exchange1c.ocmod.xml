<modification>
	<name>NeoSeo Exchange 1С</name>
	<version>158</version>
	<code>neoseo-exchange-1c</code>
	<author>NeoSeo</author>
	<link>http://neoseo.com.ua/exchange1c</link>

	<file path="admin/controller/common/column_left.php">
		<operation error="skip">
			<search><![CDATA[if ($this->user->hasPermission('access', 'catalog/manufacturer')) {]]></search>
			<add position="before"><![CDATA[			/* NeoSeo Exchange 1c - begin */
			if( $this->user->hasPermission('access','catalog/neoseo_warehouse') && isset($this->session->data['token']) ) {
				$this->language->load("catalog/neoseo_warehouse");
				if( $this->config->get("neoseo_exchange1c_status") ) {
					if ($this->user->hasPermission('access', 'catalog/neoseo_warehouse')) {
						$catalog[] = array(
							'name'	   => $this->language->get('text_neoseo_warehouse'),
							'href'     => $this->url->link('catalog/neoseo_warehouse', 'token=' . $this->session->data['token'], true),
							'children' => array()
						);
					}
				}
			}
			/* NeoSeo Exchange 1c - begin */]]></add>
		</operation>
	</file>


	<file path="admin/model/catalog/category.php">
		<operation>
			<search><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "category WHERE category_id = '" . (int)$category_id . "'");]]></search>
			<add position="after"><![CDATA[		/* NeoSeo Exchange 1c - begin */
		$this->db->query("DELETE FROM `" . DB_PREFIX . "category_to_1c` WHERE category_id = '" . (int)$category_id . "'");
		/* NeoSeo Exchange 1c - end */]]></add>
		</operation>
	</file>

	<file path="admin/controller/catalog/product.php">
		<operation>
			<search><![CDATA[$this->response->setOutput($this->load->view('catalog/product_form', $data));]]></search>
			<add position="before"><![CDATA[		/* NeoSeo Exchange 1c - begin */
		if( isset($this->request->get['product_id']) ) {
			$this->load->model("catalog/neoseo_warehouse");
        	$data['warehouses'] = $this->model_catalog_neoseo_warehouse->getProductQuantity($this->request->get['product_id']);
        	$data['code_1c'] = $this->model_catalog_product->getProductCode1c($this->request->get['product_id']);
		} else {
			$data['warehouses'] = array();
			$data['code_1c'] = '';
		}
		/* NeoSeo Exchange 1c - end */]]></add>
		</operation>
	</file>

	<file path="admin/model/catalog/product.php">
		<operation>
			<search><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product WHERE product_id = '" . (int)$product_id . "'");]]></search>
			<add position="after"><![CDATA[		/* NeoSeo Exchange 1c - begin */
		$this->db->query("DELETE FROM `" . DB_PREFIX . "product_to_1c` WHERE product_id = '" . (int)$product_id . "'");
		$this->db->query("DELETE FROM `" . DB_PREFIX . "product_warehouse` WHERE product_id = '" . (int)$product_id . "'");
		/* NeoSeo Exchange 1c - end */]]></add>
		</operation>
		<operation>
			<search><![CDATA[$data['keyword']) {]]></search>
			<add position="before"><![CDATA[		/* NeoSeo Exchange 1c - begin */
		$this->db->query("DELETE FROM " . DB_PREFIX . "product_to_1c WHERE product_id=" . (int)$product_id . "");
		if (isset($data['code_1c']) && $data['code_1c']) {
			$this->db->query("INSERT INTO " . DB_PREFIX . "product_to_1c SET product_id = '" . (int)$product_id . "', 1c_id = '" . $this->db->escape($data['code_1c']) . "'");
		}
		/* NeoSeo Exchange 1c - end */]]></add>
		</operation>
		<operation>
			<search><![CDATA[function getProduct($product_id) {]]></search>
			<add position="before"><![CDATA[	/* NeoSeo Exchange 1c - begin */
	public function getProductCode1c($product_id) {
		$query = $this->db->query('SELECT 1c_id FROM ' . DB_PREFIX . 'product_to_1c WHERE `product_id` = "' . (int)$product_id . '"');
		if( !$query->num_rows )
			return '';
		return $query->row['1c_id'];
	}
	/* NeoSeo Exchange 1c - end */]]></add>
		</operation>

	</file>

	<file path="admin/view/template/catalog/product_form.tpl">
		<operation>
			<search><![CDATA[<input type="text" name="quantity" value="<?php echo $quantity; ?>" placeholder="<?php echo $entry_quantity; ?>" id="input-quantity" class="form-control" />]]></search>
			<add position="after"><![CDATA[		<!-- NeoSeo Exchange 1c - begin -->
		<?php if( count($warehouses) > 0 ) { ?>
		<p>Остатки по складам:</p>
		<ul>
		<?php foreach( $warehouses as $warehouse ) { ?>
        <li><?php echo $warehouse['name'] . ": " . $warehouse['quantity']; ?></li>
        <?php } ?>
        <?php } ?>
		<!-- NeoSeo Exchange 1c - end -->]]></add>
		</operation>
		<operation>
			<search><![CDATA[<div class="tab-pane" id="tab-links">]]></search>
			<add position="after"><![CDATA[		<!-- NeoSeo Exchange 1c - begin -->
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-code_1c">Код 1С</label>
                <div class="col-sm-10">
                  <input type="text" name="code_1c" value="<?php echo $code_1c; ?>" placeholder="Код 1С" id="input-code_1c" class="form-control" />
                </div>
              </div>
		<!-- NeoSeo Exchange 1c - end -->]]></add>
		</operation>
	</file>

	<file path="catalog/controller/product/product.php">
		<operation>
			<search><![CDATA[$data['images'] = array();]]></search>
			<add position="before"><![CDATA[		/* NeoSeo Exchange 1c - begin */
		$this->load->model("catalog/neoseo_warehouse");
        $data['warehouses'] = $this->model_catalog_neoseo_warehouse->getProductQuantity($this->request->get['product_id']);
		/* NeoSeo Exchange 1c - end */]]></add>
		</operation>
	</file>

	<file path="catalog/view/theme/*/template/product/product.tpl">
		<operation>
			<search><![CDATA[<input type="text" name="quantity" value="<?php echo $minimum; ?>" size="2" id="input-quantity" class="form-control" />]]></search>
			<add position="after"><![CDATA[		<!-- NeoSeo Exchange 1c - begin -->
			<div class="warehouse">
		<?php if( count($warehouses) > 0 ) { ?>
		<p>Остатки по складам:</p>
		<ul>
		<?php foreach( $warehouses as $warehouse ) { ?>
        <li><?php echo $warehouse['name'] . ": " . $warehouse['quantity']; ?></li>
        <?php } ?>
        <?php } ?>
        </div>
		<!-- NeoSeo Exchange 1c - end -->]]></add>
		</operation>
	</file>


	<file path="admin/controller/sale/order.php">
		<operation>
			<search><![CDATA[public function info() {]]></search>
			<add position="after"><![CDATA[					/* NeoSeo Exchange 1c - begin */
					$this->language->load('extension/module/neoseo_exchange1c');
		$this->load->model('tool/neoseo_exchange1c');

		$data['order_export_exchange1c_status'] = $this->model_tool_neoseo_exchange1c->checkOrderTo1C($this->request->get['order_id']);

		$data['text_order_export_exchange1c'] = $this->language->get('text_order_export_exchange1c');
		$data['text_order_export_exchange1c_status_yes'] = $this->language->get('text_order_export_exchange1c_status_yes');
		$data['text_order_export_exchange1c_status_not'] = $this->language->get('text_order_export_exchange1c_status_not');
		$data['neoseo_exchange1c_order_status_sync'] = $this->config->get('neoseo_exchange1c_order_status_sync');
					/* NeoSeo Exchange 1c - end */]]></add>
		</operation>
	</file>

	<file path="admin/view/template/sale/order_info.tpl">
		<operation>
			<search><![CDATA[<td><?php echo $text_affiliate; ?>]]></search>
			<add position="before" offset="2"><![CDATA[		<!-- NeoSeo Exchange 1c - begin -->
		<tr>
                  <td><?php echo $text_order_export_exchange1c?></td>
                  <td class="text-right"  colspan="2">
                      <input type="checkbox" id="order_export_exchange1c_status" name="order_export_exchange1c_status" <?php echo $order_export_exchange1c_status ? '' : 'checked="checked"' ?> value="1" id="input-override" />
                  </td>
              </tr>
		<!-- NeoSeo Exchange 1c - end -->]]></add>
		</operation>
		<operation>
			<search><![CDATA[<?php echo $footer; ?>]]></search>
			<add position="before"><![CDATA[		<!-- NeoSeo Exchange 1c - begin -->
		<script type="text/javascript"><!--

    $('#order_export_exchange1c_status').on("click", function() {
        if($("#order_export_exchange1c_status").is(':checked')){
            var order_id = $("#order_export_exchange1c_status").attr('data-order-id');
            $.ajax({
                url: 'index.php?route=tool/neoseo_exchange1c/changeOrderExport1C&token=<?php echo $token; ?>',
                type: 'post',
                dataType: 'json',
                data: {
                    'order_id': <?php echo $order_id;?>,
            'status': $("#order_export_exchange1c_status").val(),
        },
            success: function(json) {
                $('.alert').remove();
                if (json['success']) {
                    $('.warning,.success').remove();
                    var error = '<?php echo $text_order_export_exchange1c_status_yes; ?>';
                    $('.page-header').after('<div class="alert alert-success">' + error + '</div>');
                }
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
        }else{
            var order_id = $("#order_export_exchange1c_status").attr('data-order-id');
             $.ajax({
             url: 'index.php?route=tool/neoseo_exchange1c/changeOrderExport1C&token=<?php echo $token; ?>',
             type: 'post',
             dataType: 'json',
             data: {
             'order_id': <?php echo $order_id;?>,
             'status': '0',
             },
             success: function(json) {
             $('.alert').remove();
             if (json['success']) {
             $('.warning,.success').remove();
             var error = '<?php echo $text_order_export_exchange1c_status_not; ?>';
             $('.page-header').after('<div class="alert alert-warning">' + error + '</div>');
             }
             },
             error: function(xhr, ajaxOptions, thrownError) {
             alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
             }
             });
        }
    });

    //--></script>
		<!-- NeoSeo Exchange 1c - end -->]]></add>
		</operation>
	</file>

	<file path="catalog/model/checkout/order.php">
		<operation>
			<search><![CDATA[public function addOrderHistory(]]></search>
			<add position="after"><![CDATA[		/* NeoSeo Exchange 1c - begin */
		$set_auto_tag_order = $this->config->get('neoseo_exchange1c_set_auto_tag_order');
		if ($set_auto_tag_order == 1) {
			$this->load->model('tool/neoseo_exchange1c');
			$this->model_tool_neoseo_exchange1c->setAutoTagOrder($order_id, $order_status_id);
		}
		/* NeoSeo Exchange 1c - end */]]></add>
		</operation>
	</file>

</modification>